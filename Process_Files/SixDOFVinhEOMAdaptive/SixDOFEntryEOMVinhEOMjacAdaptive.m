function F = SixDOFEntryEOMVinhEOMjacAdaptive(t,x,inputs)
% Jacobian of the equations of motion with respect to the state variables

% Length of states
num_x = length(x);
% Preallocate space for the jacobian
F = zeros(num_x);

%% Define state variables
r          = x(1);  %m,   planetocentric radius
lat   = x(2);  %rad, geocentric lat
V = x(4);   %m/s, relative velocity
gam      = x(5);  %rad, relative flight path angle
psi        = x(6);  %rad, relative heading angle
q0 = x(7);          % Quaternions
q1 = x(8);
q2 = x(9);
q3 = x(10);
Pinf = x(11);
% rho = x(12);
% Freestream density
rho = interp1q(inputs.rhoTime,inputs.rhoHist,t);

%% Other secondary states
u = V*cos(gam)*sin(psi);
v = V*cos(gam)*cos(psi);
w = -V*sin(gam);

% Sensed acceleration and gyro rates (a(1:3) = accel; a(4:6) = gyro rate)
% a = specialInterp(t,inputs.gyro,inputs.time_gyro);
a = interp1q(inputs.time_gyro,inputs.gyro,t);    
gyro = a(:);

% Gravitational constant
mu = inputs.mu;

% Planet rotation rate
omega_planet = inputs.omegaplanet;

% Determine equivalent Euler angles (in rad)
[~,~,roll] = Quat2Eul(q0,q1,q2,q3);
bank_angle = roll;

% Aerodynamic coefficients
speedSound = interp1q(inputs.actual.time,inputs.actual.cs,t);

% Calculate Mach infinity (or Mach vehicle when W = 0)
mach = V/speedSound;

% Rotation vector from veh. to body
Rveh2body = R_veh2body_wq(q0,q1,q2,q3);

% Vehicle velocity wrt ground (and wind when W = 0) in body frame
vel_body = Rveh2body*[u;v;w];

% Calculate angle-of-attack (deg) and sideslip angle (deg)
[alpha,beta] = Vw_2_alphabeta(vel_body);
alpha = deg2rad(alpha);
beta = deg2rad(beta);
[CL,CD] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alpha,beta,mach);
% CL = interp1q(inputs.CDtime,inputs.CL,t);
% CD = interp1q(inputs.CDtime,inputs.CD,t);

A = inputs.RefArea;

if length(inputs.mass) == 1
    m = inputs.mass;
else
    m = interp1q(inputs.CDtime,inputs.mass,t);
end

%% drdot - radius EOM jacobian
drdot_dr = 0;
drdot_dth = 0;
drdot_dphi = 0;
drdot_dV = sin(gam);
drdot_dgam = V*cos(gam);
drdot_dpsi = 0;
drdot = [drdot_dr,drdot_dphi,drdot_dth,drdot_dV,drdot_dgam,drdot_dpsi];

%% dthdot - longitude EOM jacobian
dthdot_dr = -(V*cos(gam)*cos(psi))/(r^2*cos(lat));
dthdot_dth = 0;
dthdot_dphi = (V*cos(gam)*cos(psi)/r)*(tan(lat)/cos(lat));
dthdot_dV = (cos(gam)*cos(psi))/(r*cos(lat));
dthdot_dgam = -(V*cos(psi)*sin(gam))/(r*cos(lat));
dthdot_dpsi = -(V*cos(gam)*sin(psi))/(r*cos(lat));
dthdot = [dthdot_dr,dthdot_dphi,dthdot_dth,dthdot_dV,dthdot_dgam,dthdot_dpsi];

%% dphidot_dr - lat EOM jacobian
dphidot_dr = -(V*cos(gam)*sin(psi))/r^2;
dphidot_dth = 0;
dphidot_dphi = 0;
dphidot_dV = (cos(gam)*sin(psi))/r;
dphidot_dgam = -(V*sin(gam)*sin(psi))/r;
dphidot_dpsi = (V*cos(gam)*cos(psi))/r;
dphidot = [dphidot_dr,dphidot_dphi,dphidot_dth,dphidot_dV,dphidot_dgam,dphidot_dpsi];

%% dV_vecdot - velocity EOM jacobian
F(1:3,1:6) = [drdot;dphidot;dthdot];
F(4:6,:) = [[                          omega_planet^2*cos(lat)*(cos(lat)*sin(gam) - cos(gam)*sin(lat)*sin(psi)) + (2*mu*sin(gam))/r^3,                                                      - omega_planet^2*r*cos(lat)*(sin(gam)*sin(lat) + cos(gam)*cos(lat)*sin(psi)) - omega_planet^2*r*sin(lat)*(cos(lat)*sin(gam) - cos(gam)*sin(lat)*sin(psi)), 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -(A*CD*V*rho)/m,                                                                                                                                                                                                                              omega_planet^2*r*cos(lat)*(cos(gam)*cos(lat) + sin(gam)*sin(lat)*sin(psi)) - (mu*cos(gam))/r^2,                                                                                         -omega_planet^2*r*cos(gam)*cos(lat)*cos(psi)*sin(lat),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          0, 0,                                                                                                                       -(A*CD*V^2)/(2*m)]
[ (omega_planet^2*cos(lat)*(cos(gam)*cos(lat) + sin(gam)*sin(lat)*sin(psi)) + (2*mu*cos(gam))/r^3 - (V^2*cos(gam))/r^2)/V,              -(omega_planet^2*r*cos(lat)*(cos(gam)*sin(lat) - cos(lat)*sin(gam)*sin(psi)) + omega_planet^2*r*sin(lat)*(cos(gam)*cos(lat) + sin(gam)*sin(lat)*sin(psi)) + 2*V*omega_planet*cos(psi)*sin(lat))/V, 0,                                                                                                                                                           ((2*V*cos(gam))/r + 2*omega_planet*cos(lat)*cos(psi) + (A*CL*V*rho)/(m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)))/V - ((V^2*cos(gam))/r - (mu*cos(gam))/r^2 + omega_planet^2*r*cos(lat)*(cos(gam)*cos(lat) + sin(gam)*sin(lat)*sin(psi)) + 2*V*omega_planet*cos(lat)*cos(psi) + (A*CL*V^2*rho)/(2*m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)))/V^2,                                                                                                                                                                                                      -((V^2*sin(gam))/r - (mu*sin(gam))/r^2 + omega_planet^2*r*cos(lat)*(cos(lat)*sin(gam) - cos(gam)*sin(lat)*sin(psi)))/V,                                                -(2*V*omega_planet*cos(lat)*sin(psi) - omega_planet^2*r*cos(lat)*cos(psi)*sin(gam)*sin(lat))/V,                                                                                                                                                                                                                                                                                                                                                -(A*CL*V*rho*((4*q1*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 - (4*q0*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3))/(4*m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)),                                                                                                                                                                                                                                                                                                                                               -(A*CL*V*rho*((4*q0*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 + (4*q1*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3))/(4*m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)),                                                                                                                                                                                                                                                                                                                                               -(A*CL*V*rho*((4*q3*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 + (4*q2*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3))/(4*m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)),                                                                                                                                                                                                                                                                                                                                                -(A*CL*V*rho*((4*q2*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 - (4*q3*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3))/(4*m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)), 0,                                                          (A*CL*V)/(2*m*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2))]
[                         ((V^2*cos(gam)*cos(psi)*tan(lat))/r^2 - (omega_planet^2*cos(lat)*cos(psi)*sin(lat))/cos(gam))/V, -(2*V*omega_planet*(cos(lat) + tan(gam)*sin(lat)*sin(psi)) + (V^2*cos(gam)*cos(psi)*(tan(lat)^2 + 1))/r + (omega_planet^2*r*cos(lat)^2*cos(psi))/cos(gam) - (omega_planet^2*r*cos(psi)*sin(lat)^2)/cos(gam))/V, 0, (2*V*omega_planet*(sin(lat) - cos(lat)*tan(gam)*sin(psi)) + (V^2*cos(gam)*cos(psi)*tan(lat))/r + (omega_planet^2*r*cos(lat)*cos(psi)*sin(lat))/cos(gam) - (A*CL*V^2*rho*(2*q0*q1 + 2*q2*q3))/(2*m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V^2 - (2*omega_planet*(sin(lat) - cos(lat)*tan(gam)*sin(psi)) + (2*V*cos(gam)*cos(psi)*tan(lat))/r - (A*CL*V*rho*(2*q0*q1 + 2*q2*q3))/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V, (2*V*omega_planet*cos(lat)*sin(psi)*(tan(gam)^2 + 1) + (V^2*cos(psi)*sin(gam)*tan(lat))/r - (omega_planet^2*r*cos(lat)*cos(psi)*sin(gam)*sin(lat))/cos(gam)^2 + (A*CL*V^2*rho*sin(gam)*(2*q0*q1 + 2*q2*q3))/(2*m*cos(gam)^2*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V, ((V^2*cos(gam)*tan(lat)*sin(psi))/r + 2*V*omega_planet*cos(lat)*cos(psi)*tan(gam) + (omega_planet^2*r*cos(lat)*sin(lat)*sin(psi))/cos(gam))/V, -((A*CL*V^2*q0*rho*(2*q0*q1 + 2*q2*q3))/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)^2) - (A*CL*V^2*q1*rho)/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)) + (A*CL*V^2*rho*((4*q1*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 - (4*q0*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3)*(2*q0*q1 + 2*q2*q3))/(4*m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V, ((A*CL*V^2*q0*rho)/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)) + (A*CL*V^2*q1*rho*(2*q0*q1 + 2*q2*q3))/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)^2) - (A*CL*V^2*rho*((4*q0*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 + (4*q1*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3)*(2*q0*q1 + 2*q2*q3))/(4*m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V, ((A*CL*V^2*q3*rho)/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)) + (A*CL*V^2*q2*rho*(2*q0*q1 + 2*q2*q3))/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)^2) - (A*CL*V^2*rho*((4*q3*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 + (4*q2*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3)*(2*q0*q1 + 2*q2*q3))/(4*m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V, -((A*CL*V^2*q3*rho*(2*q0*q1 + 2*q2*q3))/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)^2) - (A*CL*V^2*q2*rho)/(m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2)) + (A*CL*V^2*rho*((4*q2*(2*q0*q1 + 2*q2*q3))/(q0^2 - q1^2 - q2^2 + q3^2)^2 - (4*q3*(2*q0*q1 + 2*q2*q3)^2)/(q0^2 - q1^2 - q2^2 + q3^2)^3)*(2*q0*q1 + 2*q2*q3))/(4*m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(3/2)*(q0^2 - q1^2 - q2^2 + q3^2)))/V, 0, (A*CL*V*(2*q0*q1 + 2*q2*q3))/(2*m*cos(gam)*((2*q0*q1 + 2*q2*q3)^2/(q0^2 - q1^2 - q2^2 + q3^2)^2 + 1)^(1/2)*(q0^2 - q1^2 - q2^2 + q3^2))]];

% Aerodynamic jacobian
J_alpha = [ 0, 0, 0, -((sin(gam)*(2*q0^2 + 2*q3^2 - 1) + cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((sin(gam)*(2*q0*q2 - 2*q1*q3) + cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), -((V*cos(gam)*(2*q0^2 + 2*q3^2 - 1) - V*cos(psi)*sin(gam)*(2*q0*q1 - 2*q2*q3) + V*sin(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + ((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(V*sin(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(psi)*sin(gam)*(2*q0*q3 + 2*q1*q2)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), ((V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + ((V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), -((4*V*q0*sin(gam) + 2*V*q1*cos(gam)*cos(psi) - 2*V*q2*cos(gam)*sin(psi))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(2*V*q2*sin(gam) + 2*V*q3*cos(gam)*cos(psi) + 4*V*q0*cos(gam)*sin(psi)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), -((2*V*q0*cos(gam)*cos(psi) - 2*V*q3*cos(gam)*sin(psi))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(2*V*q2*cos(gam)*cos(psi) - 2*V*q3*sin(gam) + 4*V*q1*cos(gam)*sin(psi)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), ((2*V*q3*cos(gam)*cos(psi) + 2*V*q0*cos(gam)*sin(psi))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + ((2*V*q0*sin(gam) + 2*V*q1*cos(gam)*cos(psi))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), ((2*V*q2*cos(gam)*cos(psi) - 4*V*q3*sin(gam) + 2*V*q1*cos(gam)*sin(psi))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((2*V*q1*sin(gam) - 2*V*q0*cos(gam)*cos(psi))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1),0,0];
J_beta = [ 0, 0, 0, -((sin(gam)*(2*q0*q1 + 2*q2*q3) - cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(sin(gam)*(2*q0*q2 - 2*q1*q3) + cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + 2*(sin(gam)*(2*q0^2 + 2*q3^2 - 1) + cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((V*cos(gam)*(2*q0*q1 + 2*q2*q3) + V*cos(psi)*sin(gam)*(2*q0^2 + 2*q2^2 - 1) - V*sin(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) + ((2*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(psi)*sin(gam)*(2*q0*q3 + 2*q1*q2)) - 2*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(V*cos(gam)*(2*q0^2 + 2*q3^2 - 1) - V*cos(psi)*sin(gam)*(2*q0*q1 - 2*q2*q3) + V*sin(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - 2*(V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((2*V*q1*sin(gam) - 4*V*q0*cos(gam)*cos(psi) + 2*V*q3*cos(gam)*sin(psi))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(2*V*q2*sin(gam) + 2*V*q3*cos(gam)*cos(psi) + 4*V*q0*cos(gam)*sin(psi)) + 2*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(4*V*q0*sin(gam) + 2*V*q1*cos(gam)*cos(psi) - 2*V*q2*cos(gam)*sin(psi)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((2*V*q0*sin(gam) - 2*V*q2*cos(gam)*sin(psi))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(2*V*q0*cos(gam)*cos(psi) - 2*V*q3*cos(gam)*sin(psi))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)) + 2*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(2*V*q2*cos(gam)*cos(psi) - 2*V*q3*sin(gam) + 4*V*q1*cos(gam)*sin(psi)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), ((4*V*q2*cos(gam)*cos(psi) - 2*V*q3*sin(gam) + 2*V*q1*cos(gam)*sin(psi))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(2*V*q3*cos(gam)*cos(psi) + 2*V*q0*cos(gam)*sin(psi))*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3)) - 2*(2*V*q0*sin(gam) + 2*V*q1*cos(gam)*cos(psi))*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((2*V*q2*sin(gam) + 2*V*q0*cos(gam)*sin(psi))/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) + ((2*(V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(2*V*q2*cos(gam)*cos(psi) - 4*V*q3*sin(gam) + 2*V*q1*cos(gam)*sin(psi)) + 2*(2*V*q1*sin(gam) - 2*V*q0*cos(gam)*cos(psi))*(V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2)))*(V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gam)*(2*q0*q1 + 2*q2*q3) - V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gam)*(2*q0*q2 - 2*q1*q3) + V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gam)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1),0,0];
J_mach = [ 0, 0, 0, 1/speedSound, 0, 0, 0, 0, 0, 0,0,0];

dh = inputs.reltol;

alphaplus = alpha; alphaminus = alpha;
dx = abs(alpha)*dh + eps;
alphaplus = alphaplus + dx;
alphaminus = alphaminus - dx;
[CLalphaplus,CDalphaplus] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alphaplus,beta,mach);
[CLalphaminus,CDalphaminus] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alphaminus,beta,mach);
J_CL_alpha = (CLalphaplus-CLalphaminus)/(2*dx);
J_CD_alpha = (CDalphaplus-CDalphaminus)/(2*dx);

betaplus = beta; betaminus = beta;
dx = abs(beta)*dh + eps;
betaplus = betaplus + dx;
betaminus = betaminus - dx;
[CLbetaplus,CDbetaplus] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alpha,betaplus,mach);
[CLbetaminus,CDbetaminus] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alpha,betaminus,mach);
J_CL_beta = (CLbetaplus-CLbetaminus)/(2*dx);
J_CD_beta = (CDbetaplus-CDbetaminus)/(2*dx);

machplus = mach; machminus = mach;
dx = abs(mach)*dh + eps;
machplus = machplus + dx;
machminus = machminus - dx;
[CLmachplus,CDmachplus] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alpha,beta,machplus);
[CLmachminus,CDmachminus] = aero_interp2_CLCD(inputs.AOA_grid,inputs.Mach_grid,inputs.data_grid,alpha,beta,machminus);
J_CL_mach = (CLmachplus-CLmachminus)/(2*dx);
J_CD_mach = (CDmachplus-CDmachminus)/(2*dx);

J_CL_dx = J_CL_alpha.*J_alpha + J_CL_beta.*J_beta + J_CL_mach.*J_mach;      % 1 x n_x
J_CD_dx = J_CD_alpha.*J_alpha + J_CD_beta.*J_beta + J_CD_mach.*J_mach;      % 1 x n_x

d_V_vec_dCL =  [                                        0; ...
                            (A*V*rho*cos(bank_angle))/(2*m); ...
                (A*V*rho*sin(bank_angle))/(2*m*cos(gam))];          % 3 x 1
d_V_vec_dCD =  [ -(A*V^2*rho)/(2*m);...
                  0;...
                  0];                                               % 3 x 1

F(4:6,:) = F(4:6,:) + d_V_vec_dCL*J_CL_dx + d_V_vec_dCD*J_CD_dx;

% F(4:6,12) = [dVdot_drho;dgamdot_drho;dpsidot_drho];
    
%% dqdot
omega_x = gyro(1); omega_y = gyro(2); omega_z = gyro(3); 
F(7:10,:) = [[ (q2*((V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r^2 + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r^2))/2 - (q1*((V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r^2 - (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r^2))/2 - (q3*((V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r^2 + (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r^2 - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r^2))/2, (V*q1*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q2 - 2*q1*q3))/(2*r) - (V*q2*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q1 + 2*q2*q3))/(2*r) - (V*q3*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0^2 + 2*q3^2 - 1))/(2*r), 0,   (q1*((cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r - (cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q2*((cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 + (q3*((cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r + (cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2, (q2*((V*sin(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(psi)*sin(gam)*(2*q0*q3 - 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 - (q1*((V*cos(psi)*sin(gam)*(2*q0^2 + 2*q1^2 - 1))/r - (V*sin(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q3*((V*cos(psi)*sin(gam)*(2*q0*q2 + 2*q1*q3))/r + (V*sin(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(psi)*sin(gam)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2,   (q2*((V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))/r - (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q1 + 2*q2*q3))/r))/2 - (q1*((V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q2 - 2*q1*q3))/r))/2 + (q3*((V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0^2 + 2*q3^2 - 1))/r))/2,                                                                                                                                                                              (q1*((4*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q2*((2*V*q3*cos(gam)*cos(psi))/r + (4*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q3*((2*V*q2*cos(gam)*cos(psi))/r + (2*V*q1*cos(gam)*sin(psi))/r - (4*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2, (q2*((2*V*q2*cos(gam)*cos(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - omega_x/2 + (q3*((2*V*q3*cos(gam)*cos(psi))/r + (2*V*q0*cos(gam)*sin(psi))/r))/2 - (q1*((2*V*q2*cos(gam)*sin(psi))/r - (4*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 - (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/(2*r) + (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/(2*r) + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/(2*r), (q3*((2*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r))/2 - (q1*((2*V*q1*cos(gam)*sin(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - omega_y/2 - (q2*((4*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 - (V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/(2*r) - (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/(2*r) - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/(2*r), (V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/(2*r) - (q2*((2*V*q0*cos(gam)*cos(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q1*((2*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q3*((2*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (4*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 - omega_z/2 + (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/(2*r) - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/(2*r),0,0]
[ (q0*((V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r^2 - (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r^2))/2 + (q3*((V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r^2 + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r^2))/2 + (q2*((V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r^2 + (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r^2 - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r^2))/2, (V*q2*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0^2 + 2*q3^2 - 1))/(2*r) - (V*q3*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q1 + 2*q2*q3))/(2*r) - (V*q0*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q2 - 2*q1*q3))/(2*r), 0, - (q0*((cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r - (cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q3*((cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 - (q2*((cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r + (cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2, (q0*((V*cos(psi)*sin(gam)*(2*q0^2 + 2*q1^2 - 1))/r - (V*sin(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2 + (q3*((V*sin(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(psi)*sin(gam)*(2*q0*q3 - 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 + (q2*((V*cos(psi)*sin(gam)*(2*q0*q2 + 2*q1*q3))/r + (V*sin(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(psi)*sin(gam)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2,   (q0*((V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q2*((V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0^2 + 2*q3^2 - 1))/r))/2 + (q3*((V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))/r - (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q1 + 2*q2*q3))/r))/2, omega_x/2 - (q0*((4*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q2*((2*V*q2*cos(gam)*cos(psi))/r + (2*V*q1*cos(gam)*sin(psi))/r - (4*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q3*((2*V*q3*cos(gam)*cos(psi))/r + (4*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 + (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/(2*r) - (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/(2*r) - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/(2*r),                                                                                                                                                                              (q3*((2*V*q2*cos(gam)*cos(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q2*((2*V*q3*cos(gam)*cos(psi))/r + (2*V*q0*cos(gam)*sin(psi))/r))/2 + (q0*((2*V*q2*cos(gam)*sin(psi))/r - (4*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2, omega_z/2 + (q0*((2*V*q1*cos(gam)*sin(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q2*((2*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r))/2 - (q3*((4*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 - (V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/(2*r) - (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/(2*r) + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/(2*r), (q0*((2*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q3*((2*V*q0*cos(gam)*cos(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 - omega_y/2 + (q2*((2*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (4*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 - (V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/(2*r) - (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/(2*r) - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/(2*r),0,0]
[ (q3*((V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r^2 - (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r^2))/2 - (q1*((V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r^2 + (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r^2 - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r^2))/2 - (q0*((V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r^2 + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r^2))/2, (V*q0*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q1 + 2*q2*q3))/(2*r) - (V*q3*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q2 - 2*q1*q3))/(2*r) - (V*q1*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0^2 + 2*q3^2 - 1))/(2*r), 0,   (q0*((cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 + (q1*((cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r + (cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2 - (q3*((cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r - (cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2, (q3*((V*cos(psi)*sin(gam)*(2*q0^2 + 2*q1^2 - 1))/r - (V*sin(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q1*((V*cos(psi)*sin(gam)*(2*q0*q2 + 2*q1*q3))/r + (V*sin(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(psi)*sin(gam)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2 - (q0*((V*sin(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(psi)*sin(gam)*(2*q0*q3 - 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2,   (q3*((V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q0*((V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))/r - (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q1 + 2*q2*q3))/r))/2 + (q1*((V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0^2 + 2*q3^2 - 1))/r))/2, omega_y/2 + (q0*((2*V*q3*cos(gam)*cos(psi))/r + (4*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q1*((2*V*q2*cos(gam)*cos(psi))/r + (2*V*q1*cos(gam)*sin(psi))/r - (4*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q3*((4*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 + (V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/(2*r) + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/(2*r) + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/(2*r), (q1*((2*V*q3*cos(gam)*cos(psi))/r + (2*V*q0*cos(gam)*sin(psi))/r))/2 - (q0*((2*V*q2*cos(gam)*cos(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - omega_z/2 + (q3*((2*V*q2*cos(gam)*sin(psi))/r - (4*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 + (V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/(2*r) + (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/(2*r) - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/(2*r),                                                                                                                                                                              (q3*((2*V*q1*cos(gam)*sin(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q1*((2*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r))/2 + (q0*((4*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2, omega_x/2 + (q0*((2*V*q0*cos(gam)*cos(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q3*((2*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q1*((2*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (4*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 + (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/(2*r) - (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/(2*r) - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/(2*r),0,0]
[ (q0*((V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r^2 + (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r^2 - (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r^2))/2 - (q1*((V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r^2 + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r^2))/2 - (q2*((V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r^2 - (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r^2 + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r^2))/2, (V*q1*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q1 + 2*q2*q3))/(2*r) + (V*q2*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0*q2 - 2*q1*q3))/(2*r) + (V*q0*cos(gam)*cos(psi)*(tan(lat)^2 + 1)*(2*q0^2 + 2*q3^2 - 1))/(2*r), 0,   (q1*((cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 - (q0*((cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/r + (cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2 + (q2*((cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/r - (cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2, (q0*((V*cos(psi)*sin(gam)*(2*q0*q2 + 2*q1*q3))/r + (V*sin(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(psi)*sin(gam)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/r))/2 - (q1*((V*sin(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(psi)*sin(gam)*(2*q0*q3 - 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q1 + 2*q2*q3))/r))/2 - (q2*((V*cos(psi)*sin(gam)*(2*q0^2 + 2*q1^2 - 1))/r - (V*sin(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(psi)*sin(gam)*tan(lat)*(2*q0*q2 - 2*q1*q3))/r))/2, - (q2*((V*cos(gam)*cos(psi)*(2*q0*q3 + 2*q1*q2))/r + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q1^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q2 - 2*q1*q3))/r))/2 - (q0*((V*cos(gam)*cos(psi)*(2*q0*q1 - 2*q2*q3))/r - (V*cos(gam)*sin(psi)*(2*q0*q2 + 2*q1*q3))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0^2 + 2*q3^2 - 1))/r))/2 - (q1*((V*cos(gam)*sin(psi)*(2*q0*q3 - 2*q1*q2))/r - (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q2^2 - 1))/r + (V*cos(gam)*tan(lat)*sin(psi)*(2*q0*q1 + 2*q2*q3))/r))/2, omega_z/2 - (q0*((2*V*q2*cos(gam)*cos(psi))/r + (2*V*q1*cos(gam)*sin(psi))/r - (4*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q1*((2*V*q3*cos(gam)*cos(psi))/r + (4*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q2*((4*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 - (V*cos(gam)*cos(psi)*(2*q0*q2 + 2*q1*q3))/(2*r) - (V*cos(gam)*sin(psi)*(2*q0*q1 - 2*q2*q3))/(2*r) + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0^2 + 2*q3^2 - 1))/(2*r), omega_y/2 - (q1*((2*V*q2*cos(gam)*cos(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q0*((2*V*q3*cos(gam)*cos(psi))/r + (2*V*q0*cos(gam)*sin(psi))/r))/2 - (q2*((2*V*q2*cos(gam)*sin(psi))/r - (4*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 + (V*cos(gam)*cos(psi)*(2*q0*q3 - 2*q1*q2))/(2*r) + (V*cos(gam)*sin(psi)*(2*q0^2 + 2*q2^2 - 1))/(2*r) + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q1 + 2*q2*q3))/(2*r), (q1*((4*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (2*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q2*((2*V*q1*cos(gam)*sin(psi))/r - (2*V*q0*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q0*((2*V*q0*cos(gam)*cos(psi))/r - (2*V*q3*cos(gam)*sin(psi))/r))/2 - omega_x/2 - (V*cos(gam)*sin(psi)*(2*q0*q3 + 2*q1*q2))/(2*r) + (V*cos(gam)*cos(psi)*(2*q0^2 + 2*q1^2 - 1))/(2*r) + (V*cos(gam)*cos(psi)*tan(lat)*(2*q0*q2 - 2*q1*q3))/(2*r),                                                                                                                                                                              (q1*((2*V*q0*cos(gam)*cos(psi))/r + (2*V*q2*cos(gam)*cos(psi)*tan(lat))/r))/2 - (q2*((2*V*q0*cos(gam)*sin(psi))/r + (2*V*q1*cos(gam)*cos(psi)*tan(lat))/r))/2 + (q0*((2*V*q2*cos(gam)*sin(psi))/r - (2*V*q1*cos(gam)*cos(psi))/r + (4*V*q3*cos(gam)*cos(psi)*tan(lat))/r))/2,0,0]];

%% dPinfdot
F(11,:) = [ (2*V*mu*rho*sin(gam))/r^3, 0, 0, -(mu*rho*sin(gam))/r^2, -(V*mu*rho*cos(gam))/r^2, 0, 0, 0, 0, 0, 0, -(V*mu*sin(gam))/r^2];
 
%% drhodot
F(12,:) = [ (2*V*mu*rho^2*sin(gam))/(Pinf*r^3), 0, 0, -(mu*rho^2*sin(gam))/(Pinf*r^2), -(V*mu*rho^2*cos(gam))/(Pinf*r^2), 0, 0, 0, 0, 0, (V*mu*rho^2*sin(gam))/(Pinf^2*r^2), -(2*V*mu*rho*sin(gam))/(Pinf*r^2)];

%% Numerically evaluate jacobian
% Fnumeric = zeros(num_x);
% delh = 1e-11;
% parfor jj = 1:num_x
%     xplus = x; xminus = x;
%     dx = abs(x(jj))*delh + eps;
%     xplus(jj) = xplus(jj) + dx;
%     xminus(jj) = xminus(jj) - dx;
%     xdotplus = SixDOFEntryEOMVinhEOMAdaptive(t,xplus,inputs);
%     xdotminus = SixDOFEntryEOMVinhEOMAdaptive(t,xminus,inputs);
%     Fnumeric(:,jj) = (xdotplus-xdotminus)/(2*dx);
% end
%%
% keyboard
% F = Fnumeric;
%%
% if t>150
%    keyboard
% end

return
function [AOA,Sideslip,UAOA,USideslip] = calculateAOABetaVinhEOM2(state,P_vec,...
                                         vi,ve,qi,qe,wind_vel,lat,lon,primemeridian)
% Calculate AOA and beta and their uncertainties
% Assumed that num_col = num_UppertriCovarianceMatrix 
% num_row = num_time_vector
% Assumed wind velocity is expressed in the body frame
%
% Inputs
% state = state vector [position;velocity;quaternions;pressure;density]
% P_vec = vector representation of upper-tri of covariance matrix
% vi, ve = index for start and end of velocity in state vector
% qi, qe = index for start and end of quaternions in state vector
% wind_vel = wind speed in body frame
% lat = latitude
% lon = longitude
% primemeridian = prime meriadian's angle from the right ascension
% Outputs
% AOA = angle of attack
% Sideslip = sideslip angle
% UAOA = uncertainty in the angle of attack
% USideslip = uncertainty in sideslip angle

[num_t,num_c]=size(state);

% Preallocate space
AOA = zeros(num_t,1);
Sideslip = zeros(num_t,1);
UAOA = zeros(num_t,1);
USideslip = zeros(num_t,1);

Vel_veh = state(:,vi:ve);       % Column 1 = Vel, Column 2 = gamma, Column 3 = Psi(Heading angle)
Quat = state(:,qi:qe);

parfor ii = 1:num_t
    
   % States (AOA and beta)
   q0 = Quat(ii,1); q1 = Quat(ii,2); q2 = Quat(ii,3); q3 = Quat(ii,4);
   V = Vel_veh(ii,1);
   gamma = Vel_veh(ii,2);
   psi = Vel_veh(ii,3);
   [alpha,beta] = calc_AOASideslip(V,gamma,psi,q0,q1,q2,q3);      % In radians
   AOA(ii) = alpha;
   Sideslip(ii) = beta;
  
   % Uncertainty (in AOA and beta)
   holder = makemat(P_vec(ii,:));
   Pvel = holder(vi:ve,vi:ve);
   Pquat = holder(qi:qe,qi:qe);
   
   holder2 = diag(Pvel);
   realcheck = isreal(holder2);
   if realcheck ~= 1
       keyboard 
       error(['Imaginary standard deviation found. ii = ',num2str(ii)])
   end
   Uvel = holder(4,4);              % Uncertainty of the velocity parameters
   Uvelgamma = holder(5,5);
   Uvelpsi = holder(6,6);   %sqrt(holder2);
   
   
   holder3 = diag(Pquat);
   realcheck = isreal(holder3);
   if realcheck ~= 1
       keyboard 
       error(['Imaginary standard deviation found. ii = ',num2str(ii)])
   end
   Uquat = sqrt(holder3);       % Uncertainty of the quaternion parameters
   
   
   Uncer_xvec = [0;0;0;Uvel;Uvelgamma;Uvelpsi;Uquat(:)];
   
   J_alpha = [ 0, 0, 0, -((sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((sin(gamma)*(2*q0*q2 - 2*q1*q3) + cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), -((V*cos(gamma)*(2*q0^2 + 2*q3^2 - 1) - V*cos(psi)*sin(gamma)*(2*q0*q1 - 2*q2*q3) + V*sin(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + ((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(V*sin(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(psi)*sin(gamma)*(2*q0*q3 + 2*q1*q2)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), ((V*cos(gamma)*cos(psi)*(2*q0*q2 + 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0*q1 - 2*q2*q3))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + ((V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gamma)*sin(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), -((4*V*q0*sin(gamma) + 2*V*q1*cos(gamma)*cos(psi) - 2*V*q2*cos(gamma)*sin(psi))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(2*V*q2*sin(gamma) + 2*V*q3*cos(gamma)*cos(psi) + 4*V*q0*cos(gamma)*sin(psi)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), -((2*V*q0*cos(gamma)*cos(psi) - 2*V*q3*cos(gamma)*sin(psi))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(2*V*q2*cos(gamma)*cos(psi) - 2*V*q3*sin(gamma) + 4*V*q1*cos(gamma)*sin(psi)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), ((2*V*q3*cos(gamma)*cos(psi) + 2*V*q0*cos(gamma)*sin(psi))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + ((2*V*q0*sin(gamma) + 2*V*q1*cos(gamma)*cos(psi))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1), ((2*V*q2*cos(gamma)*cos(psi) - 4*V*q3*sin(gamma) + 2*V*q1*cos(gamma)*sin(psi))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - ((2*V*q1*sin(gamma) - 2*V*q0*cos(gamma)*cos(psi))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2)/((V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2/(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + 1)];
   J_beta = [ 0, 0, 0, -((sin(gamma)*(2*q0*q1 + 2*q2*q3) - cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(sin(gamma)*(2*q0*q2 - 2*q1*q3) + cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) + 2*(sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((V*cos(gamma)*(2*q0*q1 + 2*q2*q3) + V*cos(psi)*sin(gamma)*(2*q0^2 + 2*q2^2 - 1) - V*sin(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) + ((2*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(psi)*sin(gamma)*(2*q0*q3 + 2*q1*q2)) - 2*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(V*cos(gamma)*(2*q0^2 + 2*q3^2 - 1) - V*cos(psi)*sin(gamma)*(2*q0*q1 - 2*q2*q3) + V*sin(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 - 2*q1*q2))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q1^2 - 1) - V*cos(gamma)*sin(psi)*(2*q0*q3 + 2*q1*q2))*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)) - 2*(V*cos(gamma)*cos(psi)*(2*q0*q2 + 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0*q1 - 2*q2*q3))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((2*V*q1*sin(gamma) - 4*V*q0*cos(gamma)*cos(psi) + 2*V*q3*cos(gamma)*sin(psi))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(2*V*q2*sin(gamma) + 2*V*q3*cos(gamma)*cos(psi) + 4*V*q0*cos(gamma)*sin(psi)) + 2*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(4*V*q0*sin(gamma) + 2*V*q1*cos(gamma)*cos(psi) - 2*V*q2*cos(gamma)*sin(psi)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((2*V*q0*sin(gamma) - 2*V*q2*cos(gamma)*sin(psi))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(2*V*q0*cos(gamma)*cos(psi) - 2*V*q3*cos(gamma)*sin(psi))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)) + 2*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))*(2*V*q2*cos(gamma)*cos(psi) - 2*V*q3*sin(gamma) + 4*V*q1*cos(gamma)*sin(psi)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), ((4*V*q2*cos(gamma)*cos(psi) - 2*V*q3*sin(gamma) + 2*V*q1*cos(gamma)*sin(psi))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) - ((2*(2*V*q3*cos(gamma)*cos(psi) + 2*V*q0*cos(gamma)*sin(psi))*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3)) - 2*(2*V*q0*sin(gamma) + 2*V*q1*cos(gamma)*cos(psi))*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1), -((2*V*q2*sin(gamma) + 2*V*q0*cos(gamma)*sin(psi))/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(1/2) + ((2*(V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))*(2*V*q2*cos(gamma)*cos(psi) - 4*V*q3*sin(gamma) + 2*V*q1*cos(gamma)*sin(psi)) + 2*(2*V*q1*sin(gamma) - 2*V*q0*cos(gamma)*cos(psi))*(V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2)))*(V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2)))/(2*((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2)^(3/2)))/((V*sin(gamma)*(2*q0*q1 + 2*q2*q3) - V*cos(gamma)*cos(psi)*(2*q0^2 + 2*q2^2 - 1) + V*cos(gamma)*sin(psi)*(2*q0*q3 - 2*q1*q2))^2/((V*sin(gamma)*(2*q0*q2 - 2*q1*q3) + V*cos(gamma)*sin(psi)*(2*q0^2 + 2*q1^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q3 + 2*q1*q2))^2 + (V*sin(gamma)*(2*q0^2 + 2*q3^2 - 1) + V*cos(gamma)*cos(psi)*(2*q0*q1 - 2*q2*q3) - V*cos(gamma)*sin(psi)*(2*q0*q2 + 2*q1*q3))^2) + 1)];
   

   UAOA(ii) = J_alpha*Uncer_xvec;
   USideslip(ii) = J_beta*Uncer_xvec;

end

return